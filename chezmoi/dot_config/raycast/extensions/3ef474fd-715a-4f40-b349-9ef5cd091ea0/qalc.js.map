{
  "version": 3,
  "sources": ["../src/qalc.tsx"],
  "sourcesContent": ["import {\n  ActionPanel,\n  Action,\n  List,\n  Detail,\n  getPreferenceValues,\n  openExtensionPreferences,\n  environment,\n} from \"@raycast/api\";\nimport { useEffect, useRef, useState } from \"react\";\nimport { ChildProcess, ChildProcessWithoutNullStreams, spawn } from \"node:child_process\";\nimport path from \"node:path\";\nimport { accessSync, copyFileSync } from \"node:fs\";\nimport { readFile } from \"node:fs/promises\";\n\n// TODO\n// - better parse result\n// - autmate: ask user perm to download & install qalc ?\n// -x persistent qalc + restart ?\n// -x out colors + fmt\n\n// --------  os interface\n\nfunction ensureCfg() {\n  const cfgFile = \"qalc.cfg\";\n  const cfgPath = path.join(environment.supportPath, cfgFile);\n  try {\n    accessSync(cfgPath);\n  } catch {\n    const cfgAsset = path.join(environment.assetsPath, cfgFile);\n    copyFileSync(cfgAsset, cfgPath);\n  }\n}\n\nasync function loadHistory(): Promise<[string, string][]> {\n  const historyPath = path.join(environment.supportPath, \"qalc.history\");\n  try {\n    const histFile = await readFile(historyPath, { encoding: \"utf-8\" });\n    const hist: [string, string][] = [];\n    for (const line of histFile.split(\"\\n\")) if (line) hist.push([line, \"\u2015 \"]);\n    return hist.reverse();\n  } catch {\n    return [];\n  }\n}\n\nfunction spawnQalc(\n  pathsToTry: string[],\n  callback: (process: ChildProcessWithoutNullStreams) => void,\n  setErr: (arg0: [string, Error][]) => void,\n  isDead: [0 | 1],\n  errors: [string, Error][] = [],\n) {\n  const p = spawn(pathsToTry[0], [], { env: { ...process.env, QALCULATE_USER_DIR: environment.supportPath } }); // Start qalc\n  p.on(\"error\", (err) => {\n    errors.push([pathsToTry[0], err]);\n    if (!isDead[0] && pathsToTry.length > 1) spawnQalc(pathsToTry.slice(1), callback, setErr, isDead, errors);\n    else setErr(errors);\n  });\n  if (isDead[0]) p.stdin.end();\n  else callback(p);\n}\n\nfunction processMsg(s: string): string[] {\n  /*eslint no-control-regex: \"off\"*/\n  //console.log(s);\n  s = s\n    .replaceAll(/\\x1B\\[[0-9]+(;[0-9]+)?m/g, \"\") // Colors and style\n    .replaceAll(\"\\x1B[0J\", \"\") // Erase all (when modifying input)\n    .replaceAll(/\\x1B\\[[0-9]+[AG]/g, \"\"); // Move cursor (when modifying input)\n  const lines = [];\n  let bracketD = 0;\n  for (const line of s.split(\"\\n\")) {\n    if (!line) continue;\n    if (line.trim() === \">\") continue;\n    let ate = 0;\n    for (let i = 0; i < line.length; i++) {\n      const char = line[i];\n      if (char === \"(\") bracketD++;\n      else if (char === \")\") bracketD = Math.max(0, bracketD - 1);\n      else if (bracketD == 0 && (char === \"=\" || char === \"\u2248\")) {\n        lines.push(line.slice(ate, i));\n        ate = i;\n      }\n    }\n    const rest = line.slice(ate);\n    const restt = rest.trim();\n    if (rest && restt !== \"=\" && restt !== \"\u2248\") lines.push(rest);\n  }\n  if (lines.length == 0) lines.push(\"\"); // To be able to submit it\n  //console.log(lines);\n  return lines;\n}\n\n// --------  UI\n\nfunction usePreviousState<T>(v: T): T {\n  const r = useRef<T>(v);\n  useEffect(() => {\n    r.current = v;\n  }, [v]);\n  return r.current;\n}\n\nconst historyAnsPlaceholder = \"\u23F3\";\nexport default function Command() {\n  // In case the user changes executable, we need to restart everything\n  const [render, rerender] = useState(0);\n  return <ActualCommand key={render} rerender={() => rerender(render + 1)}></ActualCommand>;\n}\nfunction ActualCommand(props: { rerender: () => void }) {\n  const preferences = getPreferenceValues();\n  const [qalcProcess, setQalcProcess] = useState<ChildProcess | undefined>(undefined); // The interactive process\n  const [searchText, setSearchText] = useState(\"\");\n  const prevSearchText = usePreviousState(searchText);\n  const [data, setData] = useState<{ a: string[]; loading: boolean }>({ a: [], loading: true }); // Response\n  const [err404, set404] = useState<[string, Error][] | false>(false);\n  const history = useRef<{ a: [string, string][]; loading: boolean }>({ a: [], loading: true }); // Calculation history\n  //console.log(data);\n\n  function onQalcData(data: Buffer) {\n    const rawData = data.toString(\"utf-8\");\n    if (rawData === \"\\x1B[0J\") return;\n    //console.log(\"Dataa: %s\", rawData);\n    const parsedLines = processMsg(rawData);\n    //console.log(\"Lines: %s\", parsedLines);\n    const lastLine = parsedLines[parsedLines.length - 1];\n    if (lastLine && history.current.a.length)\n      if (history.current.a[0][1] === historyAnsPlaceholder) history.current.a[0][1] = lastLine; // Fill history ans\n    setData({ a: parsedLines, loading: false });\n  }\n\n  function onExecute() {\n    if (searchText.trim().length > 0) history.current.a.unshift([searchText, historyAnsPlaceholder]);\n    qalcProcess?.stdin?.write(\"\\x08\".repeat(searchText.length) + searchText + \"\\n\");\n  }\n\n  useEffect(() => {\n    // Process control\n    const pathsToTry = [\n      preferences[\"qalcPath\"],\n      preferences[\"qalcPathText\"],\n      preferences[\"qalcPathText\"] + (preferences[\"qalcPathText\"].endsWith(\"/\") ? \"qalc\" : \"/qalc\"),\n    ];\n    const isDead: [0 | 1] = [0];\n    let destructor = () => (isDead[0] = 1) as unknown;\n    ensureCfg();\n    loadHistory().then((hist) => {\n      // Strict mode does this twice, but with same Ref, so dedup\n      if (history.current.loading) {\n        history.current.loading = false;\n        history.current.a = [...history.current.a, ...hist];\n      }\n    });\n    spawnQalc(\n      pathsToTry,\n      (p) => {\n        p.stdout.on(\"data\", onQalcData);\n        setQalcProcess(p);\n        destructor = () => p.stdin.end();\n      },\n      set404,\n      isDead,\n    );\n    return () => destructor() as void; // Quit qalc\n  }, []);\n  useEffect(() => {\n    // Interactive input\n    if (qalcProcess?.stdin?.writable) {\n      //console.log(\"Writing %s\", searchText);\n      if (searchText.length > prevSearchText.length && searchText.startsWith(prevSearchText))\n        qalcProcess.stdin.write(searchText.slice(prevSearchText.length));\n      else if (searchText.length < prevSearchText.length && prevSearchText.startsWith(searchText))\n        qalcProcess.stdin.write(\"\\x08\".repeat(prevSearchText.length - searchText.length));\n      else qalcProcess.stdin.write(\"\\x08\".repeat(prevSearchText.length) + searchText);\n    }\n  }, [searchText, qalcProcess]);\n\n  if (err404) return Qalc404(err404, props.rerender);\n  const universalActions = (\n    <Action title=\"Execute\" shortcut={{ modifiers: [\"alt\"], key: \"enter\" }} onAction={onExecute} />\n  );\n  const is_result_empty = searchText.trim() === \"\";\n  const is_emptyview = is_result_empty && history.current.a.length === 0;\n  return (\n    <List\n      isLoading={data.loading}\n      searchText={searchText}\n      onSearchTextChange={setSearchText}\n      searchBarPlaceholder=\"Qalc anything...\"\n    >\n      {is_emptyview ? (\n        <List.EmptyView title=\"Start typing a calculation\" />\n      ) : (\n        // !is_emptyview\n        <>\n          {is_result_empty ? (\n            <></>\n          ) : (\n            // !is_result_empty\n            <List.Section title={data.a[0]}>\n              {data.a.length > 1 ? (\n                data.a.slice(1).map((line, i) => (\n                  <List.Item\n                    title={line}\n                    key={i}\n                    actions={\n                      <ActionPanel>\n                        <Action.CopyToClipboard\n                          title=\"Copy\"\n                          content={line.slice(2)} // TODO better parse\n                          shortcut={{ modifiers: [\"cmd\"], key: \".\" }}\n                        />\n                        {universalActions}\n                      </ActionPanel>\n                    }\n                  />\n                ))\n              ) : (\n                // data.a.length == 1 (no result)\n                <List.Item\n                  title=\"Execute to see the result\"\n                  key={-1}\n                  actions={<ActionPanel>{universalActions}</ActionPanel>}\n                />\n              )}\n            </List.Section>\n          )}\n          <List.Section title=\"History\">\n            {history.current.a.map(([expr, ans], i) => (\n              <List.Item\n                title={expr}\n                accessories={[{ text: ans }]}\n                key={i}\n                actions={\n                  <ActionPanel>\n                    <Action title=\"Replace Input\" onAction={() => setSearchText(expr)} />\n                    {universalActions}\n                  </ActionPanel>\n                }\n              />\n            ))}\n          </List.Section>\n        </>\n      )}\n    </List>\n  );\n}\n\nfunction Qalc404(err: [string, Error][], rerender: () => void) {\n  return (\n    <Detail\n      markdown={`Hello!\n---\nI cannot find \\`qalc\\` on your machine. Please help!\n\nIf you have \\`qalc\\` installed, you can find it by running \\`which qalc\\`. Please copy that path into the settings.\n\nYou can get \\`qalc\\` from [https://qalculate.github.io/downloads.html](https://qalculate.github.io/downloads.html)  \nor homebrew \\`brew install libqalculate\\`\n \n---\nPlaces checked:      _EACCES - permission denied (\\`chmod +x\\`), ENOENT - no such path_\n${err.map(([place, e]) => \"- \" + place + \"  \\n\" + e).join(\"\\n\")}\n---\nPress \\`Enter\\` to open settings or \\`Alt\\` \\`Enter\\` to try searching again.\n`}\n      actions={\n        <ActionPanel>\n          <Action title=\"Open Settings\" onAction={openExtensionPreferences} />\n          <Action title=\"Try Again!\" shortcut={{ modifiers: [\"alt\"], key: \"enter\" }} onAction={rerender} />\n        </ActionPanel>\n      }\n    />\n  );\n}\n"],
  "mappings": "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",
  "names": ["qalc_exports", "__export", "Command", "__toCommonJS", "import_api", "import_react", "import_node_child_process", "import_node_path", "import_node_fs", "import_promises", "import_jsx_runtime", "ensureCfg", "cfgFile", "cfgPath", "path", "cfgAsset", "loadHistory", "historyPath", "histFile", "hist", "line", "spawnQalc", "pathsToTry", "callback", "setErr", "isDead", "errors", "p", "err", "processMsg", "s", "lines", "bracketD", "ate", "i", "char", "rest", "restt", "usePreviousState", "v", "r", "historyAnsPlaceholder", "render", "rerender", "ActualCommand", "props", "preferences", "qalcProcess", "setQalcProcess", "searchText", "setSearchText", "prevSearchText", "data", "setData", "err404", "set404", "history", "onQalcData", "rawData", "parsedLines", "lastLine", "onExecute", "destructor", "Qalc404", "universalActions", "is_result_empty", "is_emptyview", "expr", "ans", "place", "e"]
}
