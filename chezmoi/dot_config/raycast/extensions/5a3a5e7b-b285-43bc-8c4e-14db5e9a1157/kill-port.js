"use strict";var y=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var b=(e,t)=>{for(var s in t)y(e,s,{get:t[s],enumerable:!0})},v=(e,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of I(t))!D.call(e,l)&&l!==s&&y(e,l,{get:()=>t[l],enumerable:!(r=$(t,l))||r.enumerable});return e};var k=e=>v(y({},"__esModule",{value:!0}),e);var U={};b(U,{default:()=>E});module.exports=k(U);var o=require("@raycast/api"),N=require("child_process"),S=require("util"),f=(0,S.promisify)(N.exec),p=new Map,C=1e4,x=/^TCP\s+(\S+)\s+\S+\s+(LISTENING|ESCUCHANDO)\s+(\d+)$/,A=/"([^"]+)","(\d+)"/;async function E(e){let{portNumber:t}=e.arguments,s=t.trim().replace(/[^0-9]/g,""),r=parseInt(s);if(!s||isNaN(r)||r<1||r>65535){await(0,o.showToast)({style:o.Toast.Style.Failure,title:"Invalid Port Number",message:`"${t}" is not a valid port. Use a number between 1-65535`});return}if([80,443,22,21,25,53,110,993,995,135,445].includes(r)){await(0,o.showToast)({style:o.Toast.Style.Failure,title:"System Port Warning",message:`Port ${r} is a system/service port. Operation cancelled for safety.`});return}let u=await(0,o.showToast)({style:o.Toast.Style.Animated,title:"\u26A1 Searching...",message:`Looking for process on port ${r}`});try{let n=await H(r);if(!n){u.hide(),await(0,o.showHUD)(`\u2705 Port ${r} is already free`);return}u.title="\u{1F4A5} Terminating...",u.message=`Killing process in port ${r} (PID: ${n.pid})`;let i=await R(n.pid);u.hide(),i?await(0,o.showHUD)(`\u{1F680} Port ${r} freed! Process terminated`):await(0,o.showToast)({style:o.Toast.Style.Failure,title:"\u274C Failed to Kill Process",message:`Could not terminate process in port ${r}. Try running as administrator.`})}catch(n){u.hide(),await(0,o.showToast)({style:o.Toast.Style.Failure,title:"Error",message:n instanceof Error?n.message:"An unexpected error occurred"})}}async function H(e){try{let t=O(e);if(t)return t;let s="",r="";try{let[n,i]=await Promise.allSettled([f("netstat -ano -p tcp",{timeout:8e3,maxBuffer:2097152,windowsHide:!0}),f("tasklist /fo csv /nh",{timeout:8e3,maxBuffer:2097152,windowsHide:!0})]);n.status==="fulfilled"&&(s=n.value.stdout),i.status==="fulfilled"&&(r=i.value.stdout)}catch(n){console.error("Command execution error:",n)}if(!s)try{s=(await f(`netstat -ano | findstr :${e}`,{timeout:5e3,maxBuffer:1048576,windowsHide:!0})).stdout}catch{throw new Error(`Failed to find process using port ${e}. Try running as administrator.`)}if(!s||s.trim().length===0)return null;let l=new Map;if(r){let n=Date.now(),i=r.split(`
`);for(let d of i)if(d.trim()){let m=A.exec(d);if(m){let[,c,a]=m;l.set(a,c),p.set(a,{name:c,timestamp:n})}}}let u=s.split(`
`);for(let n of u){let i=n.trim();if(!i||i.includes("Proto")||i.includes("Conexiones")||i.includes("activas")||i.includes("Direcci\xF3n"))continue;let d=x.exec(i),m="",c="";if(d)m=d[1],c=d[3];else{let a=i.split(/\s+/);if(a.length>=5&&a[0]==="TCP"){let P=a[1],h=a[3],w=a[4];(h==="LISTENING"||h==="ESCUCHANDO")&&P.endsWith(`:${e}`)&&w!=="0"&&(m=P,c=w)}}if(m.endsWith(`:${e}`)&&c!=="0"){let a=l.get(c)||L(c)||"Unknown Process";if(a==="Unknown Process")try{let{stdout:h}=await f(`tasklist /fo csv /nh /fi "PID eq ${c}"`,{timeout:3e3,windowsHide:!0}),w=h.match(/"([^"]+)"/);w&&(a=w[1],p.set(c,{name:a,timestamp:Date.now()}))}catch{}let P={pid:c,processName:a,localAddress:m};return F(e,P),P}}return null}catch(t){throw console.error("Port search error:",t),new Error(`Port search failed: ${t instanceof Error?t.message:"Network command execution failed"}`)}}function L(e){let t=p.get(e);return t&&Date.now()-t.timestamp<C?t.name:null}async function R(e){try{try{await f(`taskkill /PID ${e}`,{timeout:3e3,windowsHide:!0})}catch{await f(`taskkill /PID ${e} /F`,{timeout:3e3,windowsHide:!0})}return p.delete(e),!0}catch(t){return console.error("Kill process failed:",t),!1}}var g=new Map,T=5e3;function O(e){let t=g.get(e);return t&&Date.now()-t.timestamp<T?t.process:(g.delete(e),null)}function F(e,t){g.set(e,{process:t,timestamp:Date.now()})}typeof setInterval<"u"&&setInterval(()=>{let e=Date.now();for(let[t,s]of p.entries())e-s.timestamp>=C&&p.delete(t);for(let[t,s]of g.entries())e-s.timestamp>=T&&g.delete(t)},C/2);
