# ==================================================================
# ~/.zshrc — Interactive runtime (modular & fast)
# ==================================================================
# Structure: Core config → Completions → Modules → PATH

# ---- Guard: ensure ~/.zshrc is a symlink to ~/dotfiles/shell/.zshrc
if [[ -o interactive ]]; then
  _EXPECTED="$HOME/dotfiles/shell/.zshrc"

  _notify() {
    /usr/bin/osascript -e "display notification \"$1\" with title \"zshrc guard\""
  }

  if [[ ! -L "$HOME/.zshrc" ]]; then
    _notify "~/.zshrc is NOT a symlink (using local file?)"
  else
    _RESOLVED="$(
      if command -v realpath >/dev/null 2>&1; then
        realpath "$HOME/.zshrc" 2>/dev/null
      else
        python3 - <<'PY' "$HOME/.zshrc" 2>/dev/null
import os,sys
print(os.path.realpath(sys.argv[1]))
PY
      fi
    )"
    if [[ "$_RESOLVED" != "$_EXPECTED" ]]; then
      _notify "~/.zshrc points to: ${_RESOLVED}\nExpected: ${_EXPECTED}"
    fi
  fi

  unset _EXPECTED _RESOLVED
fi

# ---- 0) P10k Instant Prompt (MUST be first) ----------------------
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# ---- 1) Oh My Zsh Basic Config -----------------------------------
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="powerlevel10k/powerlevel10k"

zstyle ':omz:update' mode auto
zstyle ':omz:update' frequency 1

# ---- 2) Completion Cache ------------------------------------------
ZSH_COMPDUMP="${XDG_CACHE_HOME:-$HOME/.cache}/zsh/compdump-${ZSH_VERSION}"
autoload -Uz compinit
zstyle ':completion:*' cache-path "${XDG_CACHE_HOME:-$HOME/.cache}/zsh/completion-cache"
mkdir -p "${ZSH_COMPDUMP:h}"

# Only regenerate compdump once per day for speed
if [[ -n ${ZSH_COMPDUMP}(#qNmh-20) ]]; then
  compinit -C -d "${ZSH_COMPDUMP}"
else
  compinit -d "${ZSH_COMPDUMP}"
fi

# ---- 3) fzf-tab Styles --------------------------------------------
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}' 'r:|[._-]=** r:|=**'
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath'
zstyle ':completion:*:git-checkout:*' sort false
zstyle ':completion:*:descriptions' format '[%d]'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*' menu no
zstyle ':fzf-tab:*' fzf-flags --color=fg:1,fg+:2 --bind=tab:accept
zstyle ':fzf-tab:*' use-fzf-default-opts yes
zstyle ':fzf-tab:*' switch-group '<' '>'

# ---- 4) OMZ Plugins -----------------------------------------------
plugins=(
  aliases
  copyfile
  copypath
  direnv
  extract
  fzf-tab
  zsh-autosuggestions
  zsh-history-substring-search
  zsh-interactive-cd
)

source "$ZSH/oh-my-zsh.sh"

# ---- 5) Prompt & Navigation ---------------------------------------
[[ -r ~/.p10k.zsh ]] && source ~/.p10k.zsh

# zoxide (fast directory jumper)
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
  alias j='z'
fi

# ---- 6) Syntax Highlighting ---------------------------------------
FAST_HIGHL="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/fast-syntax-highlighting"

# Auto-install if missing (once)
if [[ ! -d "$FAST_HIGHL" ]]; then
  command -v git >/dev/null 2>&1 && \
    git clone --depth 1 https://github.com/zdharma-continuum/fast-syntax-highlighting.git "$FAST_HIGHL"
fi

# Style configuration
typeset -A FAST_HIGHLIGHT_STYLES
FAST_HIGHLIGHT_STYLES[command]='fg=green'
FAST_HIGHLIGHT_STYLES[builtin]='fg=blue'
FAST_HIGHLIGHT_STYLES[alias]='fg=cyan'
FAST_HIGHLIGHT_STYLES[function]='fg=cyan'
FAST_HIGHLIGHT_STYLES[unknown-token]='fg=red,bold'
FAST_HIGHLIGHT_STYLES[reserved-word]='fg=magenta'
FAST_HIGHLIGHT_STYLES[path]='fg=yellow'
FAST_HIGHLIGHT_STYLES[globbing]='fg=magenta'
FAST_HIGHLIGHT_STYLES[single-hyphen-option]='fg=magenta'
FAST_HIGHLIGHT_STYLES[double-hyphen-option]='fg=magenta'
FAST_HIGHLIGHT_STYLES[back-quoted-argument]='fg=yellow'

[[ -r "$FAST_HIGHL/fast-syntax-highlighting.plugin.zsh" ]] && \
  source "$FAST_HIGHL/fast-syntax-highlighting.plugin.zsh"

# ---- 7) Essential Tool Initializations ----------------------------

# fzf (fuzzy finder)
command -v fzf >/dev/null 2>&1 && source <(fzf --zsh)

# Bun (JavaScript runtime)
[[ -r "$HOME/.bun/_bun" ]] && source "$HOME/.bun/_bun"

# fclones (duplicate finder) - background to avoid blocking
command -v fclones >/dev/null 2>&1 && source <(fclones complete zsh) 2>/dev/null &!

# ---- 8) Lazy-Loaded Tools (loads on first use) -------------------
# mise, conda, thefuck, tv - deferred for faster startup
[[ -r "$HOME/dotfiles/shell/lazy-load.zsh" ]] && source "$HOME/dotfiles/shell/lazy-load.zsh"

# ---- 9) Key Bindings ----------------------------------------------

# History substring search
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down

# Menu completion
bindkey -M menuselect '^M' .accept-line
bindkey '^I' menu-complete
bindkey "$terminfo[kcbt]" reverse-menu-complete

# Undo/Redo
bindkey "^X^_" redo
bindkey "^U" backward-kill-line

# ---- 10) Load External Modules ------------------------------------
SHELL_DIR="$HOME/dotfiles/shell"

[[ -r "$SHELL_DIR/aliases.zsh" ]] && source "$SHELL_DIR/aliases.zsh"
[[ -r "$SHELL_DIR/functions.zsh" ]] && source "$SHELL_DIR/functions.zsh"
[[ -r "$SHELL_DIR/kitty.zsh" ]] && source "$SHELL_DIR/kitty.zsh"

# Claude CLI (if available)
[[ -r "$HOME/dotfiles/.claude/claude-secure/term-integration.sh" ]] && \
  source "$HOME/dotfiles/.claude/claude-secure/term-integration.sh"

# ---- 11) PATH Finalization ----------------------------------------
typeset -U path PATH
path=(
  "$HOME/.cache/lm-studio/bin"
  "$HOME/.antigravity/antigravity/bin"
  "$HOME/dotfiles/bin"
  $path
)
export PATH

# ---- 12) Final Completions ----------------------------------------
[[ -d "$HOME/.docker/completions" ]] && fpath=("$HOME/.docker/completions" $fpath)

# ---- End of configuration -----------------------------------------
